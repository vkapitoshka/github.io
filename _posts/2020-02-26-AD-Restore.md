---
layout: post
title: Восстановление контролера домена из бэкапа виртуальной машины.
description: "Описание процесса востановления контролера домена"
tags: [Administration]
author: Vlad Kap
image:
  background: triangular.png
---
В данной статье хочу описать стандартную процедуру по восстановлению контролера домена из бэкапа.

Как Вы все знаете, бэкапы необходимы хотя бы для того, чтобы не потерять сделанное или иметь возможность посмотреть, что было раньше.
В доменной инфраструктуре, Контролер домена, а точнее его База, это сердце всей инфраструктуры, так как именно она отвечает за возможноть работы большинства серверов, пользователей, систем и т.д. в вашей компании.
Поэтому потеряв её и не имея возможности восстановить, вы рискуете оказаться в начале пути Вашей компании.

Если вы выполняете восстановление контролеа домена из бэкапа вы в первую очеред востанавливаете базу данных и это необходимо делать правильно.
Сейчас практикуется резервное копирование контролера домена в виде образа виртуальной машины (Виртуализация наше ВСЁ). Восстановление из образа достаточно распространенная процедура, и я не буду это описывать здесь.
Будем считать, что виртуальная машина контролера домена восстановлена, но что важно НЕ ЗАПУЩЕНА после восстановления!

Итак процедура:
1. Нам необходимо запустить операционную систему в режиме Directory Services Restore Mode. Для этого в самом начале загрузки операционной системы нажимаем клавищу F5 и выбираем соответсвующий пункт меню Directory Services Restore Mode.

2. После того как контроле домена загрузиться в режиме восстановления логинимся в него под УЗ Administrator с паролем восстановления контролера домена (тот самы пароль, который вы назначали, когда поднимали рядовой сервер до уровня контролера домена).

3. Далее запускаем команду CMD->Regedit.exe и переходи в реестре по пути: `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters`

4. Чтобы посмотреть сколько раз восстанавливался данный контролер домена нужно найти ключ `DSA Previous Restore Count` и число указанное в нем. Если такого ключа нет, то данный контролер домена ранее не восстанавливался. В данном ключе ничего править не треубется.

5. По данному пути необходимо создать `DWORD (32-bit) ключь` с названием `Database restored from backup` и установить его значение равное 1.

6. После этого достаточно просто перезагрузить сервер в нормальном режиме.

7. Если, после загрузки, зайти по пути: `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters`, то в данной директории значение `DSA Previous Restore Count` увеличиться на единицу, а если его не было то появиться со значением 1.

Таким образом выполняется процедура восстановления контролера домена и его базы из бэкапа, если бэкап выполнялся при помощи образа виртуальной машины.